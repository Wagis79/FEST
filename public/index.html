<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FEST - Beslutsst√∂d f√∂r g√∂dselrekommendationer</title>
    
    <!-- Loading Animation -->
    <link rel="stylesheet" href="/loader/spreader-loader.css">
    
    <!-- Central CSS -->
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/pages/main.css">
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1>üåæ FEST</h1>
            <p>Beslutsst√∂d f√∂r g√∂dselrekommendationer</p>
            <div class="page-header-actions">
                <a href="/admin.html" class="btn btn-secondary" style="background: rgba(255,255,255,0.2); color: white; border: none;">
                    üîß Admin
                </a>
                <button id="productListBtn" class="product-list-btn">
                    üìã Visa tillg√§ngliga produkter
                </button>
            </div>
        </div>

        <div class="card">
            <!-- Flikar -->
            <div class="tabs">
                <!-- Toggle mellan Enkel och Avancerad (d√∂ljs i ink√∂pslista-l√§ge) -->
                <div class="balance-mode-toggle" id="formModeToggleWrapper">
                    <span class="toggle-label active" id="label-basic">üìä Enkel</span>
                    <div class="toggle-switch" id="formModeToggle">
                        <div class="toggle-slider"></div>
                    </div>
                    <span class="toggle-label" id="label-advanced">üî¨ Avancerad</span>
                </div>
                
                <!-- Tillbaka-knapp (visas endast i ink√∂pslista-l√§ge) -->
                <button id="backToCalcBtn" class="btn-back-tabs" style="display: none;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Tillbaka till ber√§kning
                </button>
                
                <button class="tab" data-tab="purchase" style="margin-left: auto;">Ink√∂pslista üìã<span id="purchaseCount" style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 5px; display: none;">0</span></button>
            </div>

            <!-- Enkel flik -->
            <div id="basic-tab" class="tab-content active">
                <h2>V√§lj gr√∂da och f√∂rv√§ntad sk√∂rd</h2>
                <form id="nutrientForm">
                <!-- Gr√∂da och sk√∂rd -->
                <div class="form-grid">
                    <div class="form-group">
                        <label for="crop">Gr√∂da</label>
                        <select id="crop">
                            <option value="">-- V√§lj gr√∂da --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="yield">F√∂rv√§ntad sk√∂rd (ton/ha)</label>
                        <input type="number" id="yield" placeholder="t.ex. 8" step="1" min="0">
                    </div>
                </div>

                <h3 style="margin-top: 25px; margin-bottom: 10px; color: #555;">
                    N√§ringsbehov (kg/ha)
                </h3>
                <small id="nutrient-info" style="color: #666; margin-bottom: 15px; display: block;">
                    üí° Kryssa i de √§mnen som M√ÖSTE uppn√•s.
                </small>
                
                <div class="form-grid">
                    <!-- Kv√§ve -->
                    <div class="form-group">
                        <label for="nitrogen" style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                            <span class="checkbox-wrapper" id="requireN-wrapper" style="display: inline;">
                                <input type="checkbox" id="requireN" checked style="width: 18px; height: 18px;">
                            </span>
                            Kv√§ve (N)
                        </label>
                        <input type="number" id="nitrogen" placeholder="t.ex. 230" step="1" min="0">
                    </div>

                    <!-- Fosfor -->
                    <div class="form-group">
                        <label for="phosphorus" style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                            <span class="checkbox-wrapper" id="requireP-wrapper" style="display: inline;">
                                <input type="checkbox" id="requireP" checked style="width: 18px; height: 18px;">
                            </span>
                            Fosfor (P)
                        </label>
                        <input type="number" id="phosphorus" placeholder="t.ex. 25" step="1" min="0">
                    </div>

                    <!-- Kalium -->
                    <div class="form-group">
                        <label for="potassium" style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                            <span class="checkbox-wrapper" id="requireK-wrapper" style="display: inline;">
                                <input type="checkbox" id="requireK" checked style="width: 18px; height: 18px;">
                            </span>
                            Kalium (K)
                        </label>
                        <input type="number" id="potassium" placeholder="t.ex. 40" step="1" min="0">
                    </div>

                    <!-- Svavel -->
                    <div class="form-group">
                        <label for="sulfur" style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                            <span class="checkbox-wrapper" id="requireS-wrapper" style="display: inline;">
                                <input type="checkbox" id="requireS" checked style="width: 18px; height: 18px;">
                            </span>
                            Svavel (S)
                        </label>
                        <input type="number" id="sulfur" placeholder="t.ex. 15" step="1" min="0">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="maxProducts">Max antal produkter</label>
                        <select id="maxProducts">
                            <option value="2">2 produkter</option>
                            <option value="3" selected>3 produkter</option>
                            <option value="4">4 produkter</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn">Ber√§kna rekommendationer</button>
            </form>
            </div>
            <!-- Slut Enkel flik -->

            <!-- Avancerad flik -->
            <div id="advanced-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Avancerad ber√§kning med n√§ringsbalans</h2>
                    
                    <!-- Toggle mellan F√∂rfrukt och V√§xtn√§ringsbalans -->
                    <div class="balance-mode-toggle">
                        <span class="toggle-label active" id="label-forfrukt">üåæ F√∂rfrukt</span>
                        <div class="toggle-switch" id="balanceToggle">
                            <div class="toggle-slider"></div>
                        </div>
                        <span class="toggle-label" id="label-balance">üìä V√§xtn√§ringsbalans</span>
                    </div>
                </div>
                
                <form id="advancedForm">
                    <!-- Sektion f√∂r F√∂rfrukt -->
                    <div id="forfrukt-section" class="balance-input-section active">
                        <!-- F√∂rfrukt och tidigare sk√∂rd -->
                        <h3 style="margin-top: 25px; margin-bottom: 10px; color: #555;">F√∂rfrukt och bortf√∂rd n√§ring</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="previousCrop">F√∂rfrukt</label>
                                <select id="previousCrop">
                                    <option value="">-- V√§lj f√∂rfrukt --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="previousYield">Faktisk sk√∂rd f√∂rfrukt (ton/ha)</label>
                                <input type="number" id="previousYield" placeholder="t.ex. 9" step="1" min="0">
                            </div>
                        </div>

                        <!-- Tillf√∂rd g√∂dsling f√∂reg√•ende √•r -->
                        <h3 style="margin-top: 25px; margin-bottom: 10px; color: #555;">Tillf√∂rd g√∂dsling f√∂reg√•ende √•r (kg/ha)</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="prevN">Kv√§ve (N)</label>
                                <input type="number" id="prevN" placeholder="t.ex. 180" step="1" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="prevP">Fosfor (P)</label>
                                <input type="number" id="prevP" placeholder="t.ex. 30" step="1" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="prevK">Kalium (K)</label>
                                <input type="number" id="prevK" placeholder="t.ex. 50" step="1" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="prevS">Svavel (S)</label>
                                <input type="number" id="prevS" placeholder="t.ex. 15" step="1" min="0" value="0">
                            </div>
                        </div>

                        <button type="button" class="btn" id="calculateBalanceBtn" style="margin-top: 20px;">Ber√§kna n√§ringsbalans fr√•n f√∂rfrukt</button>
                    </div>

                    <!-- Sektion f√∂r direkt V√§xtn√§ringsbalans -->
                    <div id="balance-section" class="balance-input-section">
                        <h3 style="margin-top: 25px; margin-bottom: 10px; color: #555;">Ing√•ende v√§xtn√§ringsbalans (kg/ha)</h3>
                        <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">
                            üí° Ange den ing√•ende n√§ringsbalansen direkt, t.ex. fr√•n jorprov eller tidigare ber√§kningar.
                        </p>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="directBalanceN">Kv√§ve (N)</label>
                                <input type="number" id="directBalanceN" placeholder="t.ex. 20" step="1" value="0">
                            </div>
                            <div class="form-group">
                                <label for="directBalanceP">Fosfor (P)</label>
                                <input type="number" id="directBalanceP" placeholder="t.ex. 5" step="1" value="0">
                            </div>
                            <div class="form-group">
                                <label for="directBalanceK">Kalium (K)</label>
                                <input type="number" id="directBalanceK" placeholder="t.ex. 15" step="1" value="0">
                            </div>
                            <div class="form-group">
                                <label for="directBalanceS">Svavel (S)</label>
                                <input type="number" id="directBalanceS" placeholder="t.ex. 3" step="1" value="0">
                            </div>
                        </div>

                        <button type="button" class="btn" id="useDirectBalanceBtn" style="margin-top: 20px;">Anv√§nd angiven n√§ringsbalans</button>
                    </div>

                    <!-- Resultat av balansber√§kning -->
                    <div id="balanceResult" class="balance-result" style="display: none;">
                        <h3 style="margin: 0 0 10px 0; color: #2196F3;">üí° Ber√§knad ing√•ende n√§ringsbalans</h3>
                        <p style="margin: 0 0 15px 0; color: #666; font-size: 0.9rem;">
                            Baserat p√• vad som tillf√∂rdes minus vad gr√∂dan tog upp
                        </p>
                        
                        <!-- Info om f√∂rfruktsv√§rde -->
                        <div id="balanceInfo" style="display: none; background: #e8f5e9; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #4CAF50; color: #2d5016; font-size: 0.9rem;"></div>
                        
                        <div class="balance-grid">
                            <div class="balance-box">
                                <div class="label">N (Kv√§ve)</div>
                                <div class="value" id="balanceN">0</div>
                                <small style="color: #999;">kg/ha</small>
                            </div>
                            <div class="balance-box">
                                <div class="label">P (Fosfor)</div>
                                <div class="value" id="balanceP">0</div>
                                <small style="color: #999;">kg/ha</small>
                            </div>
                            <div class="balance-box">
                                <div class="label">K (Kalium)</div>
                                <div class="value" id="balanceK">0</div>
                                <small style="color: #999;">kg/ha</small>
                            </div>
                            <div class="balance-box">
                                <div class="label">S (Svavel)</div>
                                <div class="value" id="balanceS">0</div>
                                <small style="color: #999;">kg/ha</small>
                            </div>
                        </div>
                    </div>

                    <!-- Aktuell gr√∂da och sk√∂rd -->
                    <h3 style="margin-top: 30px; margin-bottom: 10px; color: #555;">Aktuell gr√∂da och f√∂rv√§ntad sk√∂rd</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="advCrop">Gr√∂da</label>
                            <select id="advCrop">
                                <option value="">-- V√§lj gr√∂da --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="advYield">F√∂rv√§ntad sk√∂rd (ton/ha)</label>
                            <input type="number" id="advYield" placeholder="t.ex. 9" step="1" min="0">
                        </div>
                    </div>

                    <!-- N√§ringsbehov (auto-ber√§knat, justerat f√∂r balans) -->
                    <h3 style="margin-top: 25px; margin-bottom: 10px; color: #555;">
                        Justerat n√§ringsbehov (kg/ha)
                    </h3>
                    <small style="color: #666; margin-bottom: 15px; display: block;">
                        üí° Kryssa i de √§mnen som M√ÖSTE uppn√•s. Behovet justeras automatiskt baserat p√• ing√•ende balans.
                    </small>
                    
                    <div class="form-grid">
                        <!-- Kv√§ve -->
                        <div class="form-group">
                            <label for="advNitrogen" style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                <span class="checkbox-wrapper" id="advRequireN-wrapper" style="display: inline;">
                                    <input type="checkbox" id="advRequireN" checked style="width: 18px; height: 18px;">
                                </span>
                                Kv√§ve (N)
                            </label>
                            <input type="number" id="advNitrogen" placeholder="Ber√§knas automatiskt" step="1" min="0" readonly>
                        </div>

                        <!-- Fosfor -->
                        <div class="form-group">
                            <label for="advPhosphorus" style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                <span class="checkbox-wrapper" id="advRequireP-wrapper" style="display: inline;">
                                    <input type="checkbox" id="advRequireP" checked style="width: 18px; height: 18px;">
                                </span>
                                Fosfor (P)
                            </label>
                            <input type="number" id="advPhosphorus" placeholder="Ber√§knas automatiskt" step="1" min="0" readonly>
                        </div>

                        <!-- Kalium -->
                        <div class="form-group">
                            <label for="advPotassium" style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                <span class="checkbox-wrapper" id="advRequireK-wrapper" style="display: inline;">
                                    <input type="checkbox" id="advRequireK" checked style="width: 18px; height: 18px;">
                                </span>
                                Kalium (K)
                            </label>
                            <input type="number" id="advPotassium" placeholder="Ber√§knas automatiskt" step="1" min="0" readonly>
                        </div>

                        <!-- Svavel -->
                        <div class="form-group">
                            <label for="advSulfur" style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                <span class="checkbox-wrapper" id="advRequireS-wrapper" style="display: inline;">
                                    <input type="checkbox" id="advRequireS" checked style="width: 18px; height: 18px;">
                                </span>
                                Svavel (S)
                            </label>
                            <input type="number" id="advSulfur" placeholder="Ber√§knas automatiskt" step="1" min="0" readonly>
                        </div>
                    </div>

                    <!-- Max produkter -->
                    <div class="form-grid" style="margin-top: 20px;">
                        <div class="form-group">
                            <label for="advMaxProducts">Max antal produkter</label>
                            <select id="advMaxProducts">
                                <option value="2">2 produkter</option>
                                <option value="3" selected>3 produkter</option>
                                <option value="4">4 produkter</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn">Ber√§kna rekommendationer</button>
                </form>
            </div>
            <!-- Slut Avancerad flik -->

            <!-- Ink√∂pslista-flik -->
            <div id="purchase-tab" class="tab-content">
                <div id="purchaseTabContent">
                    <!-- Content will be dynamically added here -->
                </div>
            </div>
            <!-- Slut Ink√∂pslista-flik -->
        </div>

        <div class="error" id="error"></div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 20px; color: white; font-size: 1.2rem;">Ber√§knar rekommendationer...</p>
        </div>

        <div class="card results" id="results">
            <h2 style="margin-bottom: 20px;">Rekommendationer</h2>
            
            <div id="solutionsList"></div>
        </div>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast">
        <div class="toast-icon">‚úì</div>
        <div class="toast-message">Tillagd i ink√∂pslistan!</div>
    </div>

    <!-- Modal f√∂r att l√§gga till i ink√∂pslista -->
    <div id="addToListModal" class="modal">
        <div class="modal-content">
            <h3>üìã L√§gg till i ink√∂pslista</h3>
            <div class="form-group">
                <label for="listItemCrop">Gr√∂da</label>
                <input type="text" id="listItemCrop" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
            </div>
            <div class="form-group">
                <label for="listItemDescription">Beskrivning (valfritt)</label>
                <input type="text" id="listItemDescription" placeholder="t.ex. Klimat & Natur, S√∂dra f√§ltet">
            </div>
            <div class="form-group">
                <label for="listItemHectares">Antal hektar *</label>
                <input type="number" id="listItemHectares" placeholder="t.ex. 25" step="0.1" min="0.1" required>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" style="flex: 1;" id="cancelAddToListBtn">Avbryt</button>
                <button type="button" class="btn" style="flex: 1;" id="confirmAddToListBtn">L√§gg till</button>
            </div>
        </div>
    </div>

    <!-- Modal f√∂r utskriftsalternativ -->
    <div id="printOptionsModal" class="modal">
        <div class="modal-content">
            <h3>üñ®Ô∏è Utskriftsalternativ</h3>
            <div class="form-group">
                <label for="printCustomerName">Kundnamn (valfritt)</label>
                <input type="text" id="printCustomerName" placeholder="t.ex. Anderssons Lantbruk AB">
            </div>
            <div class="form-group">
                <label for="printQuoteNumber">Offertnummer (valfritt)</label>
                <input type="text" id="printQuoteNumber" placeholder="t.ex. OFF-2024-0042">
            </div>
            <div class="form-group" style="margin-top: 16px;">
                <label class="checkbox-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="printShowPrices" checked style="width: 18px; height: 18px;">
                    <span>Visa priser i utskriften</span>
                </label>
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button type="button" class="btn btn-secondary" style="flex: 1;" id="cancelPrintBtn">Avbryt</button>
                <button type="button" class="btn" style="flex: 1;" id="confirmPrintBtn">üñ®Ô∏è Generera PDF</button>
            </div>
        </div>
    </div>

    <!-- Produktlista Modal (m√•ste ligga f√∂re scripts f√∂r korrekt DOM-laddning) -->
    <div id="productModal" class="product-modal">
        <div class="product-modal-content">
            <div class="product-modal-header">
                <h2>üìã Tillg√§ngliga produkter f√∂r ber√§kning</h2>
                <button class="product-modal-close">&times;</button>
            </div>
            <div class="product-modal-body">
                <table class="product-table">
                    <thead>
                        <tr>
                            <th class="product-status-cell" title="Status: Normal / Tvingad / Exkluderad">Status</th>
                            <th>Artikel</th>
                            <th>Produktnamn</th>
                            <th>N (%)</th>
                            <th>P (%)</th>
                            <th>K (%)</th>
                            <th>S (%)</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">
                                <div style="color: #999;">Laddar produkter...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="product-modal-footer" id="productModalFooter">
                <span id="productCountText">Laddar...</span>
                <button id="resetExclusionsBtn" class="reset-exclusions-btn" disabled>
                    üîÑ √Öterst√§ll alla
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Modules (load in this order) -->
    <script src="/js/state.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/error-handler.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/product-exclusion.js"></script>
    <script src="/js/balance.js"></script>
    <script src="/js/tabs.js"></script>
    <script src="/js/purchase-list.js"></script>
    <script src="/js/forms.js"></script>
    <script src="/js/event-listeners.js"></script>
    <script src="/js/app.js"></script>
    
    <!-- Loading Animation Scripts -->
    <script src="/loader/spreader-loader.js"></script>
</body>
</html>
