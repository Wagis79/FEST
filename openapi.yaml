openapi: 3.0.3
info:
  title: FEST G칬dseloptimerings-API
  description: |
    REST API f칬r optimering av g칬dselblandningar baserat p친 n칛ringsbehov.
    
    ## Funktioner
    - 游꿢 **Behovsbaserad optimering** - Skicka in n칛ringsbehov (N, P, K, S) och f친 optimerade produktf칬rslag
    - 游눯 **Kostnadsminimering** - Hittar den billigaste produktkombinationen som t칛cker behoven
    - 游 **Gr칬dobaserad ber칛kning** - Ber칛kna n칛ringsbehov fr친n gr칬da och f칬rv칛ntad sk칬rd
    - 游늵 **Produktkatalog** - Lista tillg칛ngliga g칬dselprodukter
    
    ## Autentisering
    Alla API-endpoints kr칛ver en giltig API-nyckel som skickas i headern `X-API-Key`.
    
    ## Rate Limiting
    API:et har f칬ljande begr칛nsningar:
    - **Generell API:** 100 requests / 15 min per IP
    - **Optimering** (`/api/recommend`): 10 requests / min per IP
    - **Admin** (`/api/admin/*`): 30 requests / 15 min per IP
    
    Rate limit-headers inkluderas i alla svar:
    - `RateLimit-Limit`: Max antal requests
    - `RateLimit-Remaining`: 칀terst친ende requests
    - `RateLimit-Reset`: Tidpunkt f칬r reset
    
    ## Validering
    Alla requests valideras med Zod-scheman. Vid valideringsfel returneras:
    ```json
    {
      "success": false,
      "error": "Valideringsfel",
      "details": [
        { "field": "need.N", "message": "Number must be at most 500", "code": "too_big" }
      ]
    }
    ```
    
    ## Begr칛nsningar
    - Endast l칛soperationer och ber칛kningar 칛r tillg칛ngliga
    - Inga skriv- eller 칛ndringsoperationer
  version: 2.8.4
  contact:
    name: FEST API Support
  license:
    name: Proprietary

servers:
  - url: https://fest-production-d1bb.up.railway.app
    description: Produktionsserver (Railway)
  - url: http://localhost:3000
    description: Lokal utveckling

tags:
  - name: Optimering
    description: G칬dselrekommendationer och optimering
  - name: Gr칬dor
    description: Gr칬dor och behovsber칛kning
  - name: Produkter
    description: G칬dselprodukter
  - name: System
    description: Systemstatus

security:
  - ApiKeyAuth: []

paths:
  /health:
    get:
      tags: [System]
      summary: Health check
      description: Kontrollerar att servern 칛r ig친ng
      operationId: healthCheck
      security: []
      responses:
        '200':
          description: Servern 칛r ig친ng
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  status:
                    type: string
                    example: OK
                  timestamp:
                    type: string
                    format: date-time

  /api/recommend:
    post:
      tags: [Optimering]
      summary: F친 g칬dselrekommendationer
      description: |
        Huvudendpoint f칬r g칬dseloptimering. Tar emot n칛ringsbehov och returnerar 
        kostnadsoptimerade produktkombinationer.
      operationId: getRecommendations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecommendRequest'
            examples:
              basic:
                summary: Enkel rekommendation
                value:
                  need:
                    N: 150
                    P: 25
                    K: 40
                    S: 15
                  requiredNutrients: ["N", "P", "K", "S"]
                  maxProducts: 3
      responses:
        '200':
          description: Lyckad optimering
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecommendResponse'
        '400':
          description: Ogiltig input
        '401':
          description: API-nyckel saknas
        '403':
          description: Ogiltig API-nyckel

  /api/crops:
    get:
      tags: [Gr칬dor]
      summary: H칛mta alla gr칬dor
      description: Returnerar alla tillg칛ngliga gr칬dor med deras n칛ringskrav
      operationId: getCrops
      parameters:
        - name: category
          in: query
          description: Filtrera p친 gr칬dkategori
          required: false
          schema:
            type: string
            enum: [cereals, oilseeds, legumes, root_crops, grass, other]
      responses:
        '200':
          description: Lista med gr칬dor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CropsResponse'

  /api/calculate-need:
    post:
      tags: [Gr칬dor]
      summary: Ber칛kna n칛ringsbehov
      description: |
        Ber칛knar n칛ringsbehov baserat p친 vald gr칬da och f칬rv칛ntad sk칬rd.
        Kan 칛ven ta h칛nsyn till f칬rfruktseffekter.
      operationId: calculateNeed
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculateNeedRequest'
            examples:
              basic:
                summary: H칬stvete 8.5 ton/ha
                value:
                  cropId: "winter_wheat_bread"
                  yieldTonPerHa: 8.5
      responses:
        '200':
          description: Ber칛knat n칛ringsbehov
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalculateNeedResponse'
        '400':
          description: Ogiltig input
        '404':
          description: Gr칬da hittades inte

  /api/products:
    get:
      tags: [Produkter]
      summary: H칛mta alla produkter
      description: Returnerar alla tillg칛ngliga g칬dselprodukter
      operationId: getProducts
      responses:
        '200':
          description: Lista med produkter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductsResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API-nyckel f칬r extern 친tkomst

  schemas:
    NutrientNeed:
      type: object
      description: |
        N칛ringsbehov i kg/ha. Rekommenderade gr칛nsv칛rden:
        - Totalt behov: 20-600 kg/ha
        - N (kv칛ve): max 400 kg/ha f칬r b칛sta prestanda
      properties:
        N:
          type: number
          description: "Kv칛vebehov (kg/ha). Rekommenderat: 10-400"
          minimum: 0
          maximum: 500
        P:
          type: number
          description: "Fosforbehov (kg/ha). Rekommenderat: 10-100"
          minimum: 0
          maximum: 200
        K:
          type: number
          description: "Kaliumbehov (kg/ha). Rekommenderat: 10-150"
          minimum: 0
          maximum: 300
        S:
          type: number
          description: "Svavelbehov (kg/ha). Rekommenderat: 5-60"
          minimum: 0
          maximum: 100

    RecommendRequest:
      type: object
      required: [need]
      properties:
        need:
          $ref: '#/components/schemas/NutrientNeed'
        requiredNutrients:
          type: array
          items:
            type: string
            enum: [N, P, K, S]
        maxProducts:
          type: integer
          minimum: 1
          maximum: 5
          default: 3
          description: "Max antal produkter. Rekommenderat: 2-4"
        topN:
          type: integer
          default: 10
        strategy:
          type: string
          enum: [economic, optimized]
          default: economic
        excludedProductIds:
          type: array
          items:
            type: string
          description: |
            Produkt-IDs att exkludera fr친n optimering.
            Rekommenderat: max 15 produkter f칬r b칛sta resultat.
        requiredProductIds:
          type: array
          items:
            type: string
          description: |
            Produkt-IDs som M칀STE inkluderas i l칬sningen.
            Begr칛nsningar:
            - F친r ej 칬verstiga maxProducts
            - Rekommenderat: maxProducts - 1 f칬r flexibilitet
            - Produkter m친ste ha r칛tt n칛ringsinneh친ll f칬r kraven

    RecommendResponse:
      type: object
      properties:
        success:
          type: boolean
        count:
          type: integer
        warnings:
          type: array
          items:
            type: string
          description: Varningar om potentiella problem med requesten
        limits:
          type: object
          description: Rekommenderade gr칛nsv칛rden f칬r optimal prestanda
          properties:
            maxProducts:
              type: object
            requiredProductIds:
              type: object
            totalNeed:
              type: object
            nitrogen:
              type: object
        solutions:
          type: array
          items:
            type: object
            properties:
              products:
                type: array
                items:
                  type: object
                  properties:
                    productId:
                      type: string
                    name:
                      type: string
                    kgPerHa:
                      type: number
              supplied:
                $ref: '#/components/schemas/NutrientNeed'
              costPerHa:
                type: number

    CalculateNeedRequest:
      type: object
      required: [cropId, yieldTonPerHa]
      properties:
        cropId:
          type: string
        yieldTonPerHa:
          type: number
        precropId:
          type: string

    CalculateNeedResponse:
      type: object
      properties:
        success:
          type: boolean
        crop:
          type: string
        need:
          $ref: '#/components/schemas/NutrientNeed'

    ValidationError:
      type: object
      description: Zod-valideringsfel med detaljerad information
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: "Valideringsfel"
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
                description: F칛ltets s칬kv칛g (t.ex. "need.N")
              message:
                type: string
                description: Felbeskrivning
              code:
                type: string
                description: Zod-felkod (t.ex. "too_big", "invalid_type")

    RateLimitError:
      type: object
      description: Rate limit 칬verskriden
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: "F칬r m친nga f칬rfr친gningar. F칬rs칬k igen om 60 sekunder."
    ProductsResponse:
      type: object
      properties:
        success:
          type: boolean
        count:
          type: integer
        products:
          type: array
          items:
            type: object

    CropsResponse:
      type: object
      properties:
        success:
          type: boolean
        count:
          type: integer
        crops:
          type: array
          items:
            type: object